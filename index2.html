<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daily Habit Tracker</title>
    <script src="https://get.mavo.io/mavo.js"></script>
    <link rel="stylesheet" href="https://get.mavo.io/mavo.css" />
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <style>
      :root {
        --bg: #f4efea;
        --ink: #383838;
        --card: #ffffff;
        --yellow: #ffde00;
        --blue: #6fc2ff;
        --focus: #2ba5ff;
        --muted: #a1a1a1;
        --radius: 2px;
        --border-w: 2px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg);
        color: var(--ink);
        line-height: 1.6;
        font-weight: 300;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 60px 32px 32px 32px;
        position: relative;
      }

      .title {
        font-family: "Space Mono", monospace;
        font-size: clamp(32px, 5vw, 56px);
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.02em;
        margin-bottom: 16px;
      }

      .card {
        background: var(--card);
        border: var(--border-w) solid var(--ink);
        box-shadow: -8px 8px 0 0 var(--ink);
        border-radius: var(--radius);
        padding: 32px;
        margin-bottom: 24px;
        transition: transform 120ms ease-in-out;
      }

      .card:hover {
        transform: translate(6px, -6px);
        box-shadow: -14px 14px 0 0 var(--ink);
      }

      .btn {
        background: var(--bg);
        border: var(--border-w) solid var(--ink);
        border-radius: var(--radius);
        color: var(--ink);
        font: 400 16px/1.2 "Inter", sans-serif;
        text-transform: uppercase;
        padding: 16.5px 22px;
        cursor: pointer;
        transition: transform 120ms ease-in-out, box-shadow 120ms ease-in-out;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        transform: translate(6px, -6px);
        box-shadow: -6px 6px 0 0 var(--ink),
          -12px 12px 0 0 rgba(56, 56, 56, 0.1);
      }

      .btn:active {
        transform: none;
        box-shadow: none;
      }

      .btn.primary {
        background: var(--blue);
      }

      .btn:disabled {
        background: #f8f8f7;
        color: var(--muted);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .toggle-view {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .toggle-btn {
        padding: 12px 20px;
        background: var(--card);
        border: var(--border-w) solid var(--ink);
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 120ms ease;
        font: 400 14px "Inter", sans-serif;
        text-transform: uppercase;
      }

      .toggle-btn.active {
        background: var(--ink);
        color: var(--card);
      }

      .habit-item {
        background: var(--card);
        border: var(--border-w) solid var(--ink);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .habit-checkbox {
        width: 24px;
        height: 24px;
        border: var(--border-w) solid var(--ink);
        border-radius: var(--radius);
        cursor: pointer;
        position: relative;
        background: var(--bg);
        flex-shrink: 0;
      }

      .habit-checkbox.checked {
        background: var(--blue);
      }

      .habit-checkbox.checked::after {
        content: "✓";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--ink);
        font-weight: bold;
      }

      .habit-info {
        flex: 1;
      }

      .habit-title {
        font-family: "Space Mono", monospace;
        font-size: 18px;
        text-transform: uppercase;
        font-weight: 400;
        margin-bottom: 4px;
      }

      .habit-time {
        font-size: 14px;
        color: var(--muted);
      }

      .timeline {
        position: relative;
        padding-left: 40px;
        margin: 32px 0;
      }

      .timeline::before {
        content: "";
        position: absolute;
        left: 12px;
        top: 0;
        bottom: 0;
        width: var(--border-w);
        background: var(--ink);
      }

      .timeline-item {
        position: relative;
        margin-bottom: 32px;
        background: var(--card);
        border: var(--border-w) solid var(--ink);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: -6px 6px 0 0 var(--ink);
      }

      .timeline-item::before {
        content: "";
        position: absolute;
        left: -28px;
        top: 20px;
        width: 16px;
        height: 16px;
        background: var(--ink);
        border-radius: 50%;
        border: 3px solid var(--bg);
      }

      .timeline-time {
        font-family: "Space Mono", monospace;
        font-size: 14px;
        text-transform: uppercase;
        color: var(--blue);
        margin-bottom: 8px;
      }

      .input {
        background: rgba(248, 248, 247, 0.7);
        border: var(--border-w) solid var(--ink);
        border-radius: var(--radius);
        padding: 16px;
        font: 400 16px "Inter", sans-serif;
        width: 100%;
        transition: border-color 120ms ease;
      }

      .input:hover,
      .input:focus {
        border-color: var(--focus);
        outline: none;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
      }

      .stat-card {
        background: var(--card);
        border: var(--border-w) solid var(--ink);
        border-radius: var(--radius);
        padding: 20px;
        text-align: center;
        box-shadow: -4px 4px 0 0 var(--ink);
      }

      .stat-value {
        font-family: "Space Mono", monospace;
        font-size: 32px;
        font-weight: 400;
        color: var(--blue);
        margin-bottom: 8px;
      }

      .stat-label {
        font-size: 14px;
        text-transform: uppercase;
        color: var(--muted);
      }

      .week-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
        margin-bottom: 32px;
      }

      .day-card {
        background: var(--card);
        border: var(--border-w) solid var(--ink);
        border-radius: var(--radius);
        padding: 16px;
        text-align: center;
        min-height: 120px;
        cursor: pointer;
        transition: all 120ms ease;
      }

      .day-card:hover {
        transform: translateY(-2px);
        box-shadow: -6px 6px 0 0 var(--ink);
      }

      .day-card.today {
        background: var(--yellow);
      }

      .day-name {
        font-family: "Space Mono", monospace;
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 8px;
      }

      .day-date {
        font-size: 20px;
        font-weight: 400;
        margin-bottom: 8px;
      }

      .day-score {
        font-size: 14px;
        color: var(--muted);
      }

      .label-chip {
        font: 400 18px/1.4 "Space Mono", monospace;
        text-transform: uppercase;
        background: var(--ink);
        color: #fff;
        padding: 8px 12px;
        border-radius: var(--radius);
        display: inline-block;
        margin-bottom: 16px;
      }

      .month-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 24px;
      }

      .month-day {
        aspect-ratio: 1;
        background: var(--card);
        border: var(--border-w) solid var(--ink);
        border-radius: var(--radius);
        padding: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 120ms ease;
        min-height: 80px;
      }

      .month-day:hover {
        transform: translateY(-2px);
        box-shadow: -4px 4px 0 0 var(--ink);
      }

      .month-day.today {
        background: var(--yellow);
      }

      .month-day-number {
        font-family: "Space Mono", monospace;
        font-size: 14px;
        font-weight: 400;
        margin-bottom: 4px;
      }

      .month-day-score {
        font-size: 10px;
        color: var(--muted);
      }

      @media (max-width: 768px) {
        .container {
          padding: 16px;
        }

        .card {
          padding: 20px;
        }

        .week-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .month-grid {
          grid-template-columns: repeat(4, 1fr);
        }

        .header {
          padding: 40px 16px 24px 16px;
        }

        .auth-section {
          position: relative;
          top: auto;
          right: auto;
          justify-content: center;
          margin-bottom: 16px;
        }

        .auth-status {
          font-size: 12px;
          padding: 6px 12px;
        }

        .btn {
          padding: 12px 16px;
          font-size: 14px;
        }
      }

      .hidden {
        display: none;
      }

      .mv-bar {
        background: var(--ink);
        color: var(--card);
        padding: 8px 16px;
        border-radius: var(--radius);
        margin-bottom: 16px;
      }

      [mv-app] {
        max-width: none;
      }

      .no-edit [mv-edit-if] {
        display: none !important;
      }

      .auth-section {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 10;
      }

      .auth-status {
        padding: 8px 16px;
        background: var(--card);
        border: var(--border-w) solid var(--ink);
        border-radius: var(--radius);
        font-size: 14px;
        text-transform: uppercase;
        font-family: "Space Mono", monospace;
      }

      .loading {
        text-align: center;
        padding: 40px;
        font-family: "Space Mono", monospace;
        text-transform: uppercase;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div class="auth-section">
          <div class="auth-status" id="authStatus">VIEW MODE</div>
          <button class="btn" id="loginBtn" onclick="handleGoogleLogin()">
            <i data-lucide="log-in" width="16" height="16"></i>
            Login with Google
          </button>
          <button
            class="btn hidden"
            id="logoutBtn"
            onclick="handleGoogleLogout()"
          >
            <i data-lucide="log-out" width="16" height="16"></i>
            Logout
          </button>
        </div>
        <h1 class="title">Daily Habit Tracker</h1>
        <p style="font-size: 18px; font-weight: 300">
          Track your daily wellness habits and build better routines
        </p>
      </header>

      <div id="loadingIndicator" class="loading">
        <p>Loading your habit data...</p>
      </div>

      <div
        mv-app="habitTracker"
        mv-storage="https://docs.google.com/spreadsheets/d/1Myh4hNzs3unZy1cItmJMEOe_3ax0_uMjbhokiO2uZx8/edit?usp=sharing"
        mv-storage-sheet="Week2"
        id="habitApp"
        mv-permissions="read write"
        mv-auth="google"
      >
        <div class="toggle-view">
          <button class="toggle-btn active" onclick="showView('day')">
            Day View
          </button>
          <button class="toggle-btn" onclick="showView('week')">
            Week View
          </button>
          <button class="toggle-btn" onclick="showView('month')">
            Month View
          </button>
          <button class="toggle-btn mv-edit-if" onclick="showView('edit')">
            Edit Today
          </button>
        </div>

        <!-- Day View - Data Entry -->
        <div id="dayView" class="view-section">
          <div class="card">
            <div class="label-chip">Today's Habits</div>
            <h2
              style="
                font-family: 'Space Mono', monospace;
                font-size: 24px;
                text-transform: uppercase;
                margin-bottom: 24px;
              "
            >
              <span id="todayDate"></span>
            </h2>

            <div class="habit-item">
              <div
                class="habit-checkbox"
                property="exercise"
                mv-edit-type="checkbox"
                onclick="this.classList.toggle('checked')"
              ></div>
              <div class="habit-info">
                <div class="habit-title">Exercise</div>
                <div class="habit-time">Morning routine • 30+ minutes</div>
              </div>
            </div>

            <div class="habit-item">
              <div
                class="habit-checkbox"
                property="slept_on_time"
                mv-edit-type="checkbox"
                onclick="this.classList.toggle('checked')"
              ></div>
              <div class="habit-info">
                <div class="habit-title">Slept on Time</div>
                <div class="habit-time">Before 11:00 PM</div>
              </div>
            </div>

            <div class="habit-item">
              <div
                class="habit-checkbox"
                property="eat_on_time"
                mv-edit-type="checkbox"
                onclick="this.classList.toggle('checked')"
              ></div>
              <div class="habit-info">
                <div class="habit-title">Ate on Time</div>
                <div class="habit-time">Regular meal schedule</div>
              </div>
            </div>

            <div class="habit-item">
              <div
                class="habit-checkbox"
                property="protein"
                mv-edit-type="checkbox"
                onclick="this.classList.toggle('checked')"
              ></div>
              <div class="habit-info">
                <div class="habit-title">Had Protein</div>
                <div class="habit-time">With each meal</div>
              </div>
            </div>

            <div class="habit-item">
              <div
                class="habit-checkbox"
                property="winddown_done"
                mv-edit-type="checkbox"
                onclick="this.classList.toggle('checked')"
              ></div>
              <div class="habit-info">
                <div class="habit-title">Winddown Routine</div>
                <div class="habit-time">Evening preparation • 30 min</div>
              </div>
            </div>

            <div class="habit-item">
              <div
                class="habit-checkbox"
                property="sunlight"
                mv-edit-type="checkbox"
                onclick="this.classList.toggle('checked')"
              ></div>
              <div class="habit-info">
                <div class="habit-title">Saw Sunlight</div>
                <div class="habit-time">Morning exposure • 10+ min</div>
              </div>
            </div>

            <div style="margin-top: 32px">
              <label
                style="
                  font-family: 'Space Mono', monospace;
                  text-transform: uppercase;
                  font-size: 14px;
                  display: block;
                  margin-bottom: 8px;
                "
                >Sleep Time</label
              >
              <input
                type="time"
                class="input"
                property="bed_time"
                mv-edit-type="time"
              />
            </div>

            <div style="margin-top: 24px">
              <label
                style="
                  font-family: 'Space Mono', monospace;
                  text-transform: uppercase;
                  font-size: 14px;
                  display: block;
                  margin-bottom: 8px;
                "
                >Morning Light Time</label
              >
              <input
                type="time"
                class="input"
                property="morning_light_time"
                mv-edit-type="time"
              />
            </div>

            <div style="margin-top: 24px">
              <label
                style="
                  font-family: 'Space Mono', monospace;
                  text-transform: uppercase;
                  font-size: 14px;
                  display: block;
                  margin-bottom: 8px;
                "
                >Breakfast Time</label
              >
              <input
                type="time"
                class="input"
                property="breakfast_time"
                mv-edit-type="time"
              />
            </div>

            <div style="margin-top: 24px">
              <label
                style="
                  font-family: 'Space Mono', monospace;
                  text-transform: uppercase;
                  font-size: 14px;
                  display: block;
                  margin-bottom: 8px;
                "
                >Workout Time</label
              >
              <input
                type="time"
                class="input"
                property="workout_time"
                mv-edit-type="time"
              />
            </div>

            <div style="margin-top: 24px">
              <label
                style="
                  font-family: 'Space Mono', monospace;
                  text-transform: uppercase;
                  font-size: 14px;
                  display: block;
                  margin-bottom: 8px;
                "
                >Winddown Start Time</label
              >
              <input
                type="time"
                class="input"
                property="winddown_start"
                mv-edit-type="time"
              />
            </div>

            <div style="margin-top: 24px">
              <label
                style="
                  font-family: 'Space Mono', monospace;
                  text-transform: uppercase;
                  font-size: 14px;
                  display: block;
                  margin-bottom: 8px;
                "
                >Notes</label
              >
              <textarea
                class="input"
                property="notes"
                rows="4"
                placeholder="How was your day? Any challenges or wins?"
              ></textarea>
            </div>

            <div style="margin-top: 32px" mv-edit-if>
              <button class="btn primary" onclick="saveToday()">
                <i data-lucide="save" width="16" height="16"></i>
                Save Today's Habits
              </button>
            </div>
          </div>

          <div class="card">
            <div class="label-chip">Today's Timeline</div>
            <div class="timeline">
              <div class="timeline-item">
                <div class="timeline-time">7:00 AM</div>
                <div>
                  <strong>Morning Routine</strong> - Wake up and get sunlight
                  exposure
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-time">8:00 AM</div>
                <div>
                  <strong>Exercise</strong> - Physical activity for energy and
                  mood
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-time">9:00 AM</div>
                <div>
                  <strong>Breakfast</strong> - Protein-rich meal to start the
                  day
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-time">12:00 PM</div>
                <div><strong>Lunch</strong> - On-time meal with protein</div>
              </div>
              <div class="timeline-item">
                <div class="timeline-time">6:00 PM</div>
                <div><strong>Dinner</strong> - Final meal of the day</div>
              </div>
              <div class="timeline-item">
                <div class="timeline-time">9:00 PM</div>
                <div>
                  <strong>Winddown</strong> - Begin evening relaxation routine
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-time">10:30 PM</div>
                <div><strong>Screen Off</strong> - Prepare mind for sleep</div>
              </div>
              <div class="timeline-item">
                <div class="timeline-time">11:00 PM</div>
                <div>
                  <strong>Bedtime</strong> - Target sleep time for 8 hours
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Week View -->
        <div id="weekView" class="view-section hidden">
          <div class="card">
            <div class="label-chip">This Week's Progress</div>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" property="weekExerciseCount">0</div>
                <div class="stat-label">Exercise Days</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" property="weekSleepCount">0</div>
                <div class="stat-label">Sleep on Time</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" property="weekNutritionCount">0</div>
                <div class="stat-label">Nutrition Goals</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" property="weekScore">0%</div>
                <div class="stat-label">Weekly Score</div>
              </div>
            </div>

            <h3
              style="
                font-family: 'Space Mono', monospace;
                font-size: 20px;
                text-transform: uppercase;
                margin: 24px 0 16px;
              "
            >
              Daily Overview
            </h3>
            <div class="week-grid" id="weekGrid">
              <!-- Week cards will be generated by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Month View -->
        <div id="monthView" class="view-section hidden">
          <div class="card">
            <div class="label-chip">Monthly Overview</div>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" property="monthTotalDays">0</div>
                <div class="stat-label">Total Days</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" property="monthExerciseStreak">0</div>
                <div class="stat-label">Exercise Streak</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" property="monthSleepStreak">0</div>
                <div class="stat-label">Sleep Streak</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" property="monthAvgScore">0%</div>
                <div class="stat-label">Avg Daily Score</div>
              </div>
            </div>

            <div style="margin-top: 32px">
              <h3
                style="
                  font-family: 'Space Mono', monospace;
                  font-size: 20px;
                  text-transform: uppercase;
                  margin-bottom: 16px;
                "
              >
                <span id="currentMonth"></span>
              </h3>
              <div class="month-grid" id="monthGrid">
                <!-- Calendar will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <!-- Edit View (only visible when logged in) -->
        <div id="editView" class="view-section hidden mv-edit-if">
          <div class="card">
            <div class="label-chip">Edit Today's Entry</div>
            <div property="habitData">
              <div class="habit-item">
                <div class="habit-checkbox" property="completed"></div>
                <div class="habit-info">
                  <div class="habit-title" property="habitName">Habit Name</div>
                  <div class="habit-time" property="habitTime">Time</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize Lucide icons
      lucide.createIcons();

      // Global state
      let isLoggedIn = false;
      let habitData = [];
      let mavoApp = null;

      // View switching functionality
      function showView(viewName) {
        // Hide all views
        document.querySelectorAll(".view-section").forEach((view) => {
          view.classList.add("hidden");
        });

        // Show selected view
        const selectedView = document.getElementById(viewName + "View");
        if (selectedView) {
          selectedView.classList.remove("hidden");
        }

        // Update toggle buttons
        document.querySelectorAll(".toggle-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        if (event && event.target) {
          event.target.classList.add("active");
        }

        // Refresh icons after view change
        setTimeout(() => lucide.createIcons(), 100);

        // Update view-specific data
        if (viewName === "week") {
          updateWeekView();
        } else if (viewName === "month") {
          updateMonthView();
        }
      }

      // Save today's habits
      function saveToday() {
        // Collect form data
        const todayData = {
          date: new Date().toISOString().split("T")[0],
          exercise: document
            .querySelector('[property="exercise"]')
            .classList.contains("checked"),
          slept_on_time: document
            .querySelector('[property="slept_on_time"]')
            .classList.contains("checked"),
          eat_on_time: document
            .querySelector('[property="eat_on_time"]')
            .classList.contains("checked"),
          protein: document
            .querySelector('[property="protein"]')
            .classList.contains("checked"),
          winddown_done: document
            .querySelector('[property="winddown_done"]')
            .classList.contains("checked"),
          sunlight: document
            .querySelector('[property="sunlight"]')
            .classList.contains("checked"),
          bed_time: document.querySelector('[property="bed_time"]').value,
          notes: document.querySelector('[property="notes"]').value,
          timestamp: new Date().toISOString(),
        };

        // Save to local storage (in real app, this would save to Google Sheets)
        let savedData = JSON.parse(localStorage.getItem("habitData") || "[]");
        const existingIndex = savedData.findIndex(
          (d) => d.date === todayData.date
        );

        if (existingIndex >= 0) {
          savedData[existingIndex] = todayData;
        } else {
          savedData.push(todayData);
        }

        localStorage.setItem("habitData", JSON.stringify(savedData));
        habitData = savedData;

        alert("Today's habits have been saved!");
      }

      // Generate week view
      function updateWeekView() {
        const weekGrid = document.getElementById("weekGrid");
        if (!weekGrid) return;

        const today = new Date();
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay());

        const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];

        weekGrid.innerHTML = "";

        for (let i = 0; i < 7; i++) {
          const currentDate = new Date(weekStart);
          currentDate.setDate(weekStart.getDate() + i);

          const dayCard = document.createElement("div");
          dayCard.className = "day-card";

          if (currentDate.toDateString() === today.toDateString()) {
            dayCard.classList.add("today");
          }

          const dayData = getDayData(currentDate);
          const score = calculateDayScore(dayData);

          dayCard.innerHTML = `
                    <div class="day-name">${
                      dayNames[currentDate.getDay()]
                    }</div>
                    <div class="day-date">${currentDate.getDate()}</div>
                    <div class="day-score">${score}/7 habits</div>
                `;

          weekGrid.appendChild(dayCard);
        }
      }

      // Generate month view
      function updateMonthView() {
        const monthGrid = document.getElementById("monthGrid");
        const currentMonth = document.getElementById("currentMonth");
        if (!monthGrid || !currentMonth) return;

        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();

        currentMonth.textContent = today.toLocaleDateString("en-US", {
          month: "long",
          year: "numeric",
        });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        monthGrid.innerHTML = "";

        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
          const emptyDay = document.createElement("div");
          emptyDay.className = "month-day";
          emptyDay.style.opacity = "0.3";
          monthGrid.appendChild(emptyDay);
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dayCard = document.createElement("div");
          dayCard.className = "month-day";

          const currentDate = new Date(year, month, day);

          if (day === today.getDate()) {
            dayCard.classList.add("today");
          }

          const dayData = getDayData(currentDate);
          const score = calculateDayScore(dayData);

          dayCard.innerHTML = `
                    <div class="month-day-number">${day}</div>
                    <div class="month-day-score">${score}/7</div>
                `;

          monthGrid.appendChild(dayCard);
        }
      }

      // Get data for a specific day
      function getDayData(date) {
        const dateString = date.toISOString().split("T")[0];
        return habitData.find((d) => d.date === dateString) || {};
      }

      // Calculate day score
      function calculateDayScore(dayData) {
        const habits = [
          "exercise",
          "slept_on_time",
          "eat_on_time",
          "protein",
          "winddown_done",
          "sunlight",
        ];
        let score = 0;

        habits.forEach((habit) => {
          if (dayData[habit]) score++;
        });

        return score;
      }

      // Initialize the app
      function initializeApp() {
        console.log("Initializing app...");

        // Load saved data
        habitData = JSON.parse(localStorage.getItem("habitData") || "[]");

        // Set today's date
        const todayElement = document.getElementById("todayDate");
        if (todayElement) {
          todayElement.textContent = new Date().toLocaleDateString("en-US", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        }

        // Wait for Mavo to be ready before checking authentication
        if (typeof Mavo !== "undefined" && Mavo.ready) {
          Mavo.ready.then(() => {
            console.log("Mavo is ready, checking authentication...");
            checkAuthStatus();
          });
        } else {
          console.log("Mavo not ready yet, waiting...");
          // Wait for Mavo to load
          setTimeout(() => {
            if (typeof Mavo !== "undefined") {
              initializeApp();
            } else {
              console.error("Mavo failed to load");
              updateAuthUI(false);
            }
          }, 1000);
        }

        // Initialize views
        updateWeekView();
        updateMonthView();

        // Hide loading indicator
        const loadingIndicator = document.getElementById("loadingIndicator");
        const habitApp = document.getElementById("habitApp");
        if (loadingIndicator) loadingIndicator.style.display = "none";
        if (habitApp) habitApp.style.display = "block";

        // Refresh icons
        setTimeout(() => lucide.createIcons(), 100);
      }

      // Google authentication handlers
      function handleGoogleLogin() {
        // Use Mavo's Google Sheets plugin authentication
        if (mavoApp && mavoApp.storage) {
          console.log("Initiating login...");
          // The Google Sheets plugin handles OAuth authentication
          // This will redirect to Google OAuth
          mavoApp.storage.login().then(() => {
            updateAuthUI(true);
            console.log("Successfully logged in with Google:", mavoApp.storage.user);
          }).catch((error) => {
            console.error("Login failed:", error);
            // Check if it's an OAuth redirect situation
            if (error.message && error.message.includes("redirect")) {
              console.log("OAuth redirect initiated");
              return; // Don't show error for OAuth redirects
            }
            alert("Login failed. Please try again.");
          });
        } else {
          // Wait for Mavo to initialize and try again
          setTimeout(() => {
            if (Mavo.Apps.habitTracker) {
              mavoApp = Mavo.Apps.habitTracker;
              handleGoogleLogin();
            } else {
              alert("App is still loading. Please try again in a moment.");
            }
          }, 1000);
        }
      }

      function handleGoogleLogout() {
        if (mavoApp && mavoApp.storage) {
          mavoApp.storage.logout().then(() => {
            updateAuthUI(false);
            console.log("Logged out");
          }).catch((error) => {
            console.error("Logout failed:", error);
            updateAuthUI(false); // Still update UI even if logout fails
          });
        } else {
          updateAuthUI(false);
        }
      }

      function updateAuthUI(loggedIn) {
        isLoggedIn = loggedIn;
        const authStatus = document.getElementById("authStatus");
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const container = document.querySelector(".container");

        if (loggedIn) {
          if (authStatus) authStatus.textContent = "EDIT MODE";
          if (loginBtn) loginBtn.classList.add("hidden");
          if (logoutBtn) logoutBtn.classList.remove("hidden");
          container.classList.remove("no-edit");
        } else {
          if (authStatus) authStatus.textContent = "VIEW MODE";
          if (loginBtn) loginBtn.classList.remove("hidden");
          if (logoutBtn) logoutBtn.classList.add("hidden");
          container.classList.add("no-edit");
        }

        // Refresh Lucide icons
        setTimeout(() => lucide.createIcons(), 100);
      }

      // Check authentication status
      function checkAuthStatus() {
        console.log("Checking authentication status...");

        // Get Mavo app instance
        mavoApp = Mavo.Apps.habitTracker;

        console.log("Mavo app:", mavoApp);
        console.log("Mavo Apps:", Mavo.Apps);

        // Set up Mavo authentication events for Google Sheets plugin
        if (mavoApp) {
          console.log("Mavo app found, setting up authentication...");

          mavoApp.ready.then(() => {
            console.log("Mavo app is ready");
            console.log("Storage:", mavoApp.storage);
            console.log("Storage user:", mavoApp.storage?.user);

            // Check if user is already authenticated via the Google Sheets storage
            if (mavoApp.storage && mavoApp.storage.user) {
              console.log("User is already authenticated");
              updateAuthUI(true);
            } else {
              console.log("User is not authenticated");
              updateAuthUI(false);
            }
          }).catch(error => {
            console.error("Mavo app ready failed:", error);
            updateAuthUI(false);
          });

          // Listen for authentication events from the Google Sheets plugin
          mavoApp.element.addEventListener("mv-login", function(env) {
            console.log("mv-login event received", env);
            updateAuthUI(true);
          });

          mavoApp.element.addEventListener("mv-logout", function(env) {
            console.log("mv-logout event received", env);
            updateAuthUI(false);
          });
        } else {
          console.log("Mavo app not found, retrying in 1 second...");
          // Retry after a delay
          setTimeout(checkAuthStatus, 1000);
        }
      }

      // Initialize when DOM is ready
      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
