<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Habit Tracker · Index7</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?
  family=Inter:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body
    class="min-h-screen bg-neutral-950 text-neutral-100 antialiased selection:bg-indigo-600/30 selection:text-indigo-200"
    style="
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI,
        Roboto, Helvetica, Arial;
    "
  >
    <!-- Shell -->
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
      <!-- Header -->
      <header class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div
            class="grid place-items-center w-9 h-9 bg-neutral-900 text-indigo-300 uppercase tracking-tight"
            style="
              border: 2px solid #2e2e2e;
              border-radius: 2px;
              box-shadow: -8px 8px 0 0 #383838;
              font-family: 'Space Mono', ui-monospace;
            "
          >
            HT
          </div>
          <div>
            <h1 class="text-[22px] sm:text-2xl font-semibold tracking-tight">
              Habit Tracker
            </h1>
            <p class="text-neutral-400 text-sm">
              Circadian, fasting, movement, and wind‑down — at a glance.
            </p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div id="auth-status" class="text-sm text-neutral-400"></div>
          <button
            id="auth-btn"
            class="px-3.5 py-2 text-sm bg-neutral-900 hover:bg-neutral-800 active:bg-neutral-700 transition-colors"
            style="border: 2px solid #2e2e2e; border-radius: 2px"
          >
            <span class="inline-flex items-center gap-2">
              <i data-lucide="log-in" stroke-width="1.5" class="w-4 h-4"></i>
              <span>Sign in</span>
            </span>
          </button>
        </div>
      </header>

      <!-- Mode / Range Controls -->
      <section class="mt-6 flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-2">
          <div
            class="uppercase text-xs text-neutral-400"
            style="font-family: 'Space Mono', ui-monospace"
          >
            Viewing
          </div>
          <div
            id="range-toggle"
            class="inline-flex bg-neutral-900"
            style="border: 2px solid #2e2e2e; border-radius: 2px"
          >
            <button
              data-view="week"
              class="px-3 py-1.5 text-sm text-neutral-100 hover:bg-neutral-800 focus:outline-none focus- visible:ring-2 focus-visible:ring-indigo-500"
            >
              Week
            </button>
            <button
              data-view="month"
              class="px-3 py-1.5 text-sm text-neutral-400 hover:bg-neutral-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500"
            >
              Month
            </button>
          </div>
          <div id="auth-hint" class="text-xs text-neutral-500">
            Sign in to unlock 3‑day check‑ins.
          </div>
        </div>
        <div class="flex items-center gap-2 text-xs text-neutral-400">
          <span
            class="uppercase"
            style="font-family: 'Space Mono', ui-monospace"
            >Key</span
          >
          <span
            class="inline-flex items-center gap-1 px-2 py-1 bg-neutral-900"
            style="border:2px solid #2e2e2e; border-
  radius:2px;"
            ><i data-lucide="sun" stroke-width="1.5" class="w-3.5 h-3.5"></i>
            Light</span
          >
          <span
            class="inline-flex items-center gap-1 px-2 py-1 bg-neutral-900"
            style="border:2px solid #2e2e2e; border-
  radius:2px;"
            ><i
              data-lucide="dumbbell"
              stroke-width="1.5"
              class="w-3.5 h-3.5"
            ></i>
            Workout</span
          >
          <span
            class="inline-flex items-center gap-1 px-2 py-1 bg-neutral-900"
            style="border:2px solid #2e2e2e; border-
  radius:2px;"
            ><i
              data-lucide="footprints"
              stroke-width="1.5"
              class="w-3.5 h-3.5"
            ></i>
            Walk</span
          >
          <span
            class="inline-flex items-center gap-1 px-2 py-1 bg-neutral-900"
            style="border:2px solid #2e2e2e; border-
  radius:2px;"
            ><i data-lucide="timer" stroke-width="1.5" class="w-3.5 h-3.5"></i>
            Fasting</span
          >
          <span
            class="inline-flex items-center gap-1 px-2 py-1 bg-neutral-900"
            style="border:2px solid #2e2e2e; border-
  radius:2px;"
            ><i data-lucide="guitar" stroke-width="1.5" class="w-3.5 h-3.5"></i>
            Guitar</span
          >
          <span
            class="inline-flex items-center gap-1 px-2 py-1 bg-neutral-900"
            style="border:2px solid #2e2e2e; border-
  radius:2px;"
            ><i
              data-lucide="stretch-horizontal"
              stroke-width="1.5"
              class="w-3.5 h-3.5"
            ></i>
            Stretch</span
          >
          <span
            class="inline-flex items-center gap-1 px-2 py-1 bg-neutral-900"
            style="border:2px solid #2e2e2e; border-
  radius:2px;"
            ><i
              data-lucide="notebook-pen"
              stroke-width="1.5"
              class="w-3.5 h-3.5"
            ></i>
            Journal</span
          >
          <span
            class="inline-flex items-center gap-1 px-2 py-1 bg-neutral-900"
            style="border:2px solid #2e2e2e; border-
  radius:2px;"
            ><i
              data-lucide="moon-star"
              stroke-width="1.5"
              class="w-3.5 h-3.5"
            ></i>
            Social</span
          >
        </div>
      </section>

      <!-- Tips / Encouragement -->
      <section class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
          <!-- Authenticated (3-day rolling) -->
          <div id="rolling" class="hidden">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-xl font-semibold tracking-tight">
                3‑day rolling check‑ins
              </h2>
              <div class="text-sm text-neutral-400" id="rolling-dates"></div>
            </div>
            <div
              id="days-container"
              class="grid grid-cols-1 md:grid-cols-3 gap-4"
            ></div>
          </div>

          <!-- Public dashboards (Week / Month) -->
          <div id="dashboards">
            <div id="week-view" class="">
              <div class="mb-3 flex items-center justify-between">
                <h2 class="text-xl font-semibold tracking-tight">This Week</h2>
                <div class="text-sm text-neutral-400" id="week-range"></div>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div
                  class="lg:col-span-2 p-4 bg-neutral-900"
                  style="border:2px solid #2e2e2e; border-radius:2px; box-
  shadow:-8px 8px 0 0 #383838;"
                >
                  <div class="grid grid-cols-7 gap-2 text-center">
                    <template id="week-cell-template">
                      <div
                        class="px-2 py-2 bg-neutral-950/50 text-sm"
                        style="border: 2px solid #2e2e2e; border-radius: 2px"
                      ></div>
                    </template>
                    <div id="week-grid" class="contents"></div>
                  </div>
                </div>
                <div
                  class="p-4 bg-neutral-900"
                  style="
                    border: 2px solid #2e2e2e;
                    border-radius: 2px;
                    box-shadow: -8px 8px 0 0 #383838;
                  "
                >
                  <h3 class="font-medium mb-2">Completion trend</h3>
                  <div class="h-40">
                    <div class="h-full">
                      <canvas id="week-chart" class="w-full h-full"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="month-view" class="hidden">
              <div class="mb-3 flex items-center justify-between">
                <h2 class="text-xl font-semibold tracking-tight">This Month</h2>
                <div class="flex items-center gap-2">
                  <button
                    id="prev-month"
                    class="px-2 py-1 text-sm bg-neutral-900 hover:bg-neutral-800"
                    style="border: 2px solid #2e2e2e; border-radius: 2px"
                  >
                    <i
                      data-lucide="chevron-left"
                      stroke-width="1.5"
                      class="w-4 h-4"
                    ></i>
                  </button>
                  <div id="month-label" class="text-sm text-neutral-400"></div>
                  <button
                    id="next-month"
                    class="px-2 py-1 text-sm bg-neutral-900 hover:bg-neutral-800"
                    style="border: 2px solid #2e2e2e; border-radius: 2px"
                  >
                    <i
                      data-lucide="chevron-right"
                      stroke-width="1.5"
                      class="w-4 h-4"
                    ></i>
                  </button>
                </div>
              </div>
              <div
                class="p-4 bg-neutral-900"
                style="
                  border: 2px solid #2e2e2e;
                  border-radius: 2px;
                  box-shadow: -8px 8px 0 0 #383838;
                "
              >
                <div id="month-grid" class="grid grid-cols-7 gap-2"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Encouragement / Tips -->
        <aside
          class="p-4 bg-neutral-900"
          style="
            border: 2px solid #2e2e2e;
            border-radius: 2px;
            box-shadow: -8px 8px 0 0 #383838;
          "
        >
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-medium tracking-tight">Tips & Boost</h3>
            <button
              id="tip-refresh"
              class="text-xs px-2 py-1 bg-neutral-950 hover:bg-neutral-800"
              style="border: 2px solid #2e2e2e; border-radius: 2px"
            >
              <span class="inline-flex items-center gap-1"
                ><i
                  data-lucide="refresh-cw"
                  stroke-width="1.5"
                  class="w-3.5 h- 3.5"
                ></i>
                New</span
              >
            </button>
          </div>
          <ul id="tips" class="space-y-2 text-sm text-neutral-300"></ul>
          <div id="encouragement" class="mt-4 text-sm text-indigo-300"></div>
        </aside>
      </section>

      <!-- Notes / Sleep Entry (visible when authenticated) -->
      <section id="notes-panel" class="mt-6 hidden">
        <div
          class="p-4 bg-neutral-900"
          style="
            border: 2px solid #2e2e2e;
            border-radius: 2px;
            box-shadow: -8px 8px 0 0 #383838;
          "
        >
          <h2 class="text-xl font-semibold tracking-tight mb-3">Daily Notes</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="md:col-span-1">
              <label
                class="block text-xs uppercase text-neutral-400 mb-1"
                style="font-family: 'Space Mono', ui- monospace"
                >Sleep at</label
              >
              <input
                id="sleep-time"
                type="time"
                class="w-full bg-neutral-950 px-3 py-2 placeholder-neutral-500 focus:outline- none focus-visible:ring-2 focus-visible:ring-indigo-500"
                style="border: 2px solid #2e2e2e; border-radius: 2px"
              />
            </div>
            <div class="md:col-span-2">
              <label
                class="block text-xs uppercase text-neutral-400 mb-1"
                style="font-family: 'Space Mono', ui- monospace"
                >Notes</label
              >
              <textarea
                id="notes-text"
                rows="3"
                class="w-full bg-neutral-950 px-3 py-2 placeholder-neutral-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500"
                style="border: 2px solid #2e2e2e; border-radius: 2px"
                placeholder="e.g., Slept at 11:05 PM. Sauna + stretch felt great."
              ></textarea>
            </div>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <button
              id="save-notes"
              class="px-3.5 py-2 text-sm bg-indigo-600/20 text-indigo-200 hover:bg-indigo-600/30"
              style="border: 2px solid #3f3f3f; border-radius: 2px"
            >
              <span class="inline-flex items-center gap-2"
                ><i data-lucide="save" stroke-width="1.5" class="w-4 h-4"></i>
                Save</span
              >
            </button>
            <div id="save-status" class="text-xs text-neutral-400"></div>
          </div>
        </div>
      </section>

      <!-- Dense string debug (collapsed) -->
      <details id="debug" class="mt-6">
        <summary class="text-xs text-neutral-500 cursor-pointer">
          Developer · dense store preview
        </summary>
        <pre
          id="dense-preview"
          class="mt-2 text-xs whitespace-pre-wrap bg-neutral-900 p-3"
          style="border: 2px solid #2e2e2e; border-radius: 2px"
        ></pre>
      </details>

      <footer
        class="mt-10 pt-6 text-center text-xs text-neutral-500 border-t border-neutral-800/80"
      >
        Built for weekly rhythms. Read public • Sign in to edit.
      </footer>
    </div>

    <script type="module">
            // Firebase SDK (v10 modular)
            import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
            import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/
      firebasejs/10.12.2/firebase-auth.js';
            import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

            const firebaseConfig = {
              apiKey: "AIzaSyBMeY1TI-Hl7iZM43auDihG-7Ckx-6JBtY",
              authDomain: "cool-90147.firebaseapp.com",
              databaseURL: "https://cool-90147.firebaseio.com",
              projectId: "cool-90147",
              storageBucket: "cool-90147.firebasestorage.app",
              messagingSenderId: "64561792498",
              appId: "1:64561792498:web:d0eda52272bb90efab176b"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const provider = new GoogleAuthProvider();
            const db = getDatabase(app);

            // UI Elements
            const authBtn = document.getElementById('auth-btn');
            const authStatus = document.getElementById('auth-status');
            const authHint = document.getElementById('auth-hint');
            const rangeToggle = document.getElementById('range-toggle');
            const rolling = document.getElementById('rolling');
            const dashboards = document.getElementById('dashboards');
            const weekView = document.getElementById('week-view');
            const monthView = document.getElementById('month-view');
            const weekGrid = document.getElementById('week-grid');
            const weekCellTemplate = document.getElementById('week-cell-template');
            const weekRange = document.getElementById('week-range');
            const weekChartEl = document.getElementById('week-chart');
            const daysContainer = document.getElementById('days-container');
            const rollingDates = document.getElementById('rolling-dates');
            const monthGrid = document.getElementById('month-grid');
            const monthLabel = document.getElementById('month-label');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const notesPanel = document.getElementById('notes-panel');
            const sleepTime = document.getElementById('sleep-time');
            const notesText = document.getElementById('notes-text');
            const saveNotesBtn = document.getElementById('save-notes');
            const saveStatus = document.getElementById('save-status');
            const densePreview = document.getElementById('dense-preview');
            const tipList = document.getElementById('tips');
            const tipRefresh = document.getElementById('tip-refresh');
            const encouragement = document.getElementById('encouragement');

            // Habits (bit positions 0..7)
            const HABITS = [
              { id: 'morningLight', label: 'Morning Light', icon: 'sun', bit: 0, tip: 'Light first thing: 10 minutes outside or 10k
      lux.' },
              { id: 'workout', label: 'Workout', icon: 'dumbbell', bit: 1, tip: 'Morning strength or cardio; prep clothes night
      before.' },
              { id: 'walk', label: 'Walk', icon: 'footprints', bit: 2, tip: 'Midday 10–15 min outdoor walk.' },
              { id: 'fastingMet', label: 'Fasting Window', icon: 'timer', bit: 3, tip: 'Meals within daylight; avoid eating 3h before
      bed.' },
              { id: 'guitar', label: 'Guitar', icon: 'guitar', bit: 4, tip: '25 min guitar at 8 PM under warm light.' },
              { id: 'stretch', label: 'Stretch', icon: 'stretch-horizontal', bit: 5, tip: '10–15 min stretch; slow exhale 6–8s.' },
              { id: 'journal', label: 'Journal', icon: 'notebook-pen', bit: 6, tip: 'Voice journal 10 min; offload thoughts before
      sleep.' },
              { id: 'socialNight', label: 'Social Night', icon: 'moon-star', bit: 7, tip: 'If late, recover next day: light +
      hydration.' },
            ];

            // Dense string storage format
            // Segment: YY-DDD=HH[,s=HH:MM][,n=ENCODED]; ...
            // HH is two-hex-digit bitmask for the 8 habits.
            function dayKey(date) {
              const yy = (date.getFullYear() % 100).toString().padStart(2, '0');
              const doy = dayOfYear(date).toString();
              return `${yy}-${doy}`; // e.g., 25-300
            }
            function dayOfYear(date) {
              const start = new Date(date.getFullYear(), 0, 0);
              const diff = date - start;
              const oneDay = 1000 * 60 * 60 * 24;
              return Math.floor(diff / oneDay);
            }
            function parseDense(blob) {
              const map = new Map();
              if (!blob || typeof blob !== 'string') return map;
              const segments = blob.split(';').map(s => s.trim()).filter(Boolean);
              for (const seg of segments) {
                const [k, rest] = seg.split('=');
                if (!k || !rest) continue;
                const parts = rest.split(',');
                const bitsHex = parts[0];
                const obj = { bits: parseInt(bitsHex, 16) || 0 };
                for (let i = 1; i < parts.length; i++) {
                  const [pk, pv] = parts[i].split('=');
                  if (pk === 's') obj.s = pv || '';
                  if (pk === 'n') obj.n = decodeURIComponent(pv || '');
                }
                map.set(k, obj);
              }
              return map;
            }
            function serializeDense(map) {
              const pieces = [];
              for (const [k, v] of map.entries()) {
                const base = v.bits.toString(16).padStart(2, '0');
                const extra = [];
                if (v.s) extra.push(`s=${v.s}`);
                if (v.n) extra.push(`n=${encodeURIComponent(v.n)}`);
                pieces.push(`${k}=${[base, ...extra].join(',')}`);
              }
              return pieces.join(';');
            }

            // App state
            let user = null;
            let denseBlob = '';
            let denseMap = new Map();
            let currentMonth = new Date();
            let weekChart = null;

            // Tips pulled from notes
            const TIPS = [
              'Bright early, dim late — anchor circadian rhythm.',
              'End fast near 4 PM; keep evenings light and calm.',
              'On late nights: hydrate, sunlight, gentle movement next day.',
              'Cue → Routine → Reward: prep guitar and mat at 7:50 PM.',
              'If mind spins at night: get up, dim light, easy reading.',
              'Walk 10–15 min midday to reinforce daylight anchor.',
              'Identity: “I wake early, train, and wind down with music.”',
              'Slow breathing: 4s in, 6–8s out to relax.',
            ];

            function pickTips(count = 3) {
              const shuffled = [...TIPS].sort(() => Math.random() - 0.5);
              return shuffled.slice(0, count);
            }
            function renderTips() {
              tipList.innerHTML = '';
              for (const tip of pickTips()) {
                const li = document.createElement('li');
                li.className = 'flex gap-2';
                li.innerHTML = `<i data-lucide="sparkles" stroke-width="1.5" class="w-4 h-4 text-indigo-300"></i><span>${tip}</
      span>`;
                tipList.appendChild(li);
              }
            }

            function encouragementForToday(bits) {
              const done = HABITS.filter(h => bits & (1 << h.bit)).length;
              if (done >= 6) return 'Phenomenal consistency — you\'re building real momentum.';
              if (done >= 4) return 'Nice flow today — keep nudging the next one.';
              if (done >= 1) return 'A start beats perfect — stack the next small win.';
              return 'Light + water gets things moving — you\'ve got this.';
            }

            // Firebase read/write
            async function loadDense() {
              try {
                const snapshot = await get(ref(db, 'habitsTracker'));
                denseBlob = snapshot.exists() ? (snapshot.val() || '') : '';
              } catch (e) {
                console.warn('Read failed, using empty store', e);
                denseBlob = '';
              }
              denseMap = parseDense(denseBlob);
              densePreview.textContent = denseBlob || '(empty)';
            }

            async function saveDense() {
              try {
                denseBlob = serializeDense(denseMap);
                await set(ref(db, 'habitsTracker'), denseBlob);
                densePreview.textContent = denseBlob;
              } catch (e) {
                console.error('Write failed', e);
                throw e;
              }
            }

            // UI helpers
            function setActiveRange(view) {
              const buttons = [...rangeToggle.querySelectorAll('button')];
              for (const b of buttons) {
                b.classList.toggle('text-neutral-100', b.dataset.view === view);
                b.classList.toggle('text-neutral-400', b.dataset.view !== view);
                b.classList.toggle('bg-neutral-800', b.dataset.view === view);
              }
              weekView.classList.toggle('hidden', view !== 'week');
              monthView.classList.toggle('hidden', view !== 'month');
              lucide.createIcons();
            }

            function bitsForDate(date) {
              const key = dayKey(date);
              const entry = denseMap.get(key) || { bits: 0 };
              return entry.bits;
            }
            function setBitsForDate(date, bits) {
              const key = dayKey(date);
              const entry = denseMap.get(key) || { bits: 0 };
              entry.bits = bits >>> 0;
              denseMap.set(key, entry);
            }
            function getNotesForDate(date) {
              const key = dayKey(date);
              return denseMap.get(key) || { bits: 0 };
            }
            function setNotesForDate(date, s, n) {
              const key = dayKey(date);
              const entry = denseMap.get(key) || { bits: 0 };
              entry.s = s || '';
              entry.n = n || '';
              denseMap.set(key, entry);
            }

            function renderRolling() {
              const today = new Date();
              const days = [0, -1, -2].map(d => new Date(today.getFullYear(), today.getMonth(), today.getDate() + d));
              rollingDates.textContent = days.map(d => d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day:
      'numeric' })).join(' • ');
              daysContainer.innerHTML = '';
              for (const date of days) {
                const key = dayKey(date);
                const bits = bitsForDate(date);
                const card = document.createElement('div');
                card.className = 'p-4 bg-neutral-900';
                card.setAttribute('style', 'border:2px solid #2e2e2e; border-radius:2px; box-shadow:-8px 8px 0 0 #383838;');
                const title = date.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' });
                card.innerHTML = `
                  <div class="flex items-center justify-between mb-2">
                    <div class="font-medium tracking-tight">${title}</div>
                    <div class="text-xs text-neutral-400">${key}</div>
                  </div>
                  <div class="space-y-2">
                    ${HABITS.map(h => {
                      const on = (bits & (1 << h.bit)) !== 0;
                      const id = `${key}-${h.id}`;
                      return `
                        <button data-toggle="${h.id}" data-key="${key}" class="w-full flex items-center justify-between px-3 py-2 bg-
      neutral-950 hover:bg-neutral-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500" style="border:2px solid
      ${on ? '#4f46e5' : '#2e2e2e'}; border-radius:2px;">
                          <span class="inline-flex items-center gap-2">
                            <i data-lucide="${h.icon}" stroke-width="1.5" class="w-4.5 h-4.5"></i>
                            <span>${h.label}</span>
                          </span>
                          <span class="uppercase text-xs px-2 py-0.5 ${on ? 'text-indigo-200 bg-indigo-600/20' : 'text-neutral-400
      bg-neutral-900'}" style="border:2px solid ${on ? '#3f3f3f' : '#2e2e2e'}; border-radius:2px; font-family: 'Space Mono', ui-
      monospace;">${on ? 'Done' : '—'}</span>
                        </button>`;
                    }).join('')}
                  </div>
                `;
                daysContainer.appendChild(card);
              }
              lucide.createIcons();

              // Attach listeners (delegated)
              daysContainer.querySelectorAll('[data-toggle]').forEach(btn => {
                btn.addEventListener('click', async () => {
                  if (!user) return; // edit requires login
                  const key = btn.getAttribute('data-key');
                  const id = btn.getAttribute('data-toggle');
                  const [yy, doy] = key.split('-');
                  // reconstruct date from year & day-of-year for today.year
                  const year = 2000 + parseInt(yy, 10);
                  const date = new Date(year, 0, parseInt(doy, 10));
                  let bits = bitsForDate(date);
                  const habit = HABITS.find(h => h.id === id);
                  bits = bits ^ (1 << habit.bit);
                  setBitsForDate(date, bits);
                  await saveDense().catch(() => {});
                  renderRolling();
                  renderWeek();
                  renderMonth(currentMonth);
                  renderEncouragement();
                })
              });
            }

            function renderEncouragement() {
              const today = new Date();
              const bits = bitsForDate(today);
              encouragement.textContent = encouragementForToday(bits);
            }

            function startOfWeek(date) {
              const d = new Date(date);
              const day = d.getDay();
              const diff = (day + 6) % 7; // Monday as start
              d.setDate(d.getDate() - diff);
              d.setHours(0,0,0,0);
              return d;
            }
            function renderWeek() {
              const now = new Date();
              const start = startOfWeek(now);
              const days = Array.from({ length: 7 }, (_, i) => new Date(start.getFullYear(), start.getMonth(), start.getDate() + i));
              weekRange.textContent = `${days[0].toLocaleDateString(undefined, { month:'short', day:'numeric' })} —
      ${days[6].toLocaleDateString(undefined, { month:'short', day:'numeric' })}`;
              weekGrid.innerHTML = '';
              const scores = [];
              for (const d of days) {
                const clone = weekCellTemplate.content.firstElementChild.cloneNode(true);
                const bits = bitsForDate(d);
                const count = HABITS.filter(h => bits & (1 << h.bit)).length;
                scores.push(count);
                clone.innerHTML = `
                  <div class="text-xs text-neutral-400">${d.toLocaleDateString(undefined, { weekday: 'short' })}</div>
                  <div class="text-sm">${d.getDate()}</div>
                  <div class="mt-1 flex items-center justify-center gap-1">
                    ${HABITS.map(h => `<span class=\"w-1.5 h-1.5 rounded-full ${ (bits & (1<<h.bit)) ? 'bg-indigo-400' : 'bg-neutral-
      700'}\"></span>`).join('')}
                  </div>
                  <div class="mt-1 text-xs ${count>=5?'text-indigo-300':'text-neutral-400'}">${count}/8</div>
                `;
                weekGrid.appendChild(clone);
              }
              // Chart
              if (weekChart) weekChart.destroy();
              weekChart = new Chart(weekChartEl.getContext('2d'), {
                type: 'bar',
                data: {
                  labels: days.map(d => d.toLocaleDateString(undefined, { weekday: 'short' })),
                  datasets: [{
                    label: 'Checks',
                    data: scores,
                    backgroundColor: 'rgba(99, 102, 241, 0.35)',
                    borderColor: 'rgba(99, 102, 241, 0.8)',
                    borderWidth: 1.5,
                    borderRadius: 2,
                  }]
                },
                options: {
                  animation: false,
                  scales: {
                    y: { beginAtZero: true, max: 8, grid: { color: '#27272a' }, ticks: { color: '#a3a3a3', stepSize: 2 } },
                    x: { grid: { display: false }, ticks: { color: '#a3a3a3' } }
                  },
                  plugins: { legend: { display: false } }
                }
              });
              lucide.createIcons();
            }

            function renderMonth(baseDate) {
              const year = baseDate.getFullYear();
              const month = baseDate.getMonth();
              const first = new Date(year, month, 1);
              const last = new Date(year, month + 1, 0);
              const startDay = (first.getDay() + 6) % 7; // Monday
              const total = startDay + last.getDate();
              monthLabel.textContent = first.toLocaleDateString(undefined, { month:'long', year:'numeric' });
              monthGrid.innerHTML = '';
              for (let i = 0; i < total; i++) {
                const cell = document.createElement('div');
                cell.className = 'px-2 py-2 bg-neutral-950/50 text-sm';
                cell.setAttribute('style', 'border:2px solid #2e2e2e; border-radius:2px;');
                if (i < startDay) {
                  monthGrid.appendChild(cell);
                  continue;
                }
                const day = i - startDay + 1;
                const d = new Date(year, month, day);
                const bits = bitsForDate(d);
                const count = HABITS.filter(h => bits & (1 << h.bit)).length;
                cell.innerHTML = `
                  <div class="flex items-center justify-between">
                    <div class="text-xs text-neutral-400">${d.toLocaleDateString(undefined, { weekday: 'short' })}</div>
                    <div class="text-xs ${count>=5?'text-indigo-300':'text-neutral-400'}">${count}/8</div>
                  </div>
                  <div class="mt-1 font-medium">${day}</div>
                  <div class="mt-1 flex flex-wrap gap-1">
                    ${HABITS.map(h => `<span class=\"w-1.5 h-1.5 rounded-full ${ (bits & (1<<h.bit)) ? 'bg-indigo-400' : 'bg-neutral-
      700'}\"></span>`).join('')}
                  </div>
                `;
                monthGrid.appendChild(cell);
              }
              lucide.createIcons();
            }

            // Notes save
            saveNotesBtn.addEventListener('click', async () => {
              if (!user) return;
              saveStatus.textContent = 'Saving...';
              const d = new Date();
              setNotesForDate(d, (sleepTime.value || '').slice(0,5), notesText.value || '');
              try {
                await saveDense();
                saveStatus.textContent = 'Saved';
                setTimeout(() => saveStatus.textContent = '', 1200);
              } catch (e) {
                saveStatus.textContent = 'Failed to save';
              }
            });

            // Toggle between week and month (public views)
            rangeToggle.addEventListener('click', (e) => {
              const btn = e.target.closest('button[data-view]');
              if (!btn) return;
              setActiveRange(btn.dataset.view);
            });

            // Auth
            async function doLogin() {
              try {
                await signInWithPopup(auth, provider);
              } catch (e) {
                console.warn('Sign-in cancelled or failed', e);
              }
            }
            async function doLogout() {
              try {
                await signOut(auth);
              } catch {}
            }
            authBtn.addEventListener('click', () => {
              if (user) doLogout(); else doLogin();
            });

            onAuthStateChanged(auth, async (u) => {
              user = u;
              if (user) {
                authStatus.textContent = user.displayName ? `Hi, ${user.displayName.split(' ')[0]}` : 'Signed in';
                authBtn.innerHTML = `<span class=\"inline-flex items-center gap-2\"><i data-lucide=\"log-out\" stroke-width=\"1.5\"
      class=\"w-4 h-4\"></i><span>Sign out</span></span>`;
                rolling.classList.remove('hidden');
                dashboards.classList.add('hidden');
                authHint.classList.add('hidden');
                notesPanel.classList.remove('hidden');
              } else {
                authStatus.textContent = 'Viewing public data';
                authBtn.innerHTML = `<span class=\"inline-flex items-center gap-2\"><i data-lucide=\"log-in\" stroke-width=\"1.5\"
      class=\"w-4 h-4\"></i><span>Sign in</span></span>`;
                rolling.classList.add('hidden');
                dashboards.classList.remove('hidden');
                authHint.classList.remove('hidden');
                notesPanel.classList.add('hidden');
              }
              lucide.createIcons();
              await loadDense();
              // Populate current day notes
              const todayEntry = getNotesForDate(new Date());
              sleepTime.value = todayEntry.s || '';
              notesText.value = todayEntry.n || '';
              // Render appropriate views
              renderMonth(currentMonth);
              renderTips();

            prevMonthBtn.addEventListener('click', () => {
              currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
              renderMonth(currentMonth);
            });
            nextMonthBtn.addEventListener('click', () => {
              currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
              renderMonth(currentMonth);
            });

            tipRefresh.addEventListener('click', () => {
              renderTips();
              lucide.createIcons();
            });

            // Initial UI
            setActiveRange('week');
            lucide.createIcons();
    </script>
  </body>
</html>
